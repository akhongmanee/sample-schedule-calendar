<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sample Schedule Calendar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .modal {
            transition: opacity 0.25s ease;
        }
        .modal-content {
            transition: transform 0.25s ease;
        }
        /* Tooltip for timeline markers */
        .timeline-marker .tooltip {
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .timeline-marker:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }
        .color-swatch {
            transition: transform 0.1s ease;
        }
        .color-swatch.selected {
            transform: scale(1.2);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5); /* ring-blue-500 with opacity */
        }
        #colorFilters .filter-swatch.selected {
             box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5);
             border-color: rgba(59, 130, 246, 0.7);
        }
        .view-btn.active {
            background-color: #3b82f6; /* bg-blue-500 */
            color: white;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 id="mainHeader" class="text-3xl md:text-4xl font-bold text-gray-900">Monthly Sample Schedule</h1>
            <p class="text-md text-gray-600 mt-2">Visualize your sample collection timeline</p>
        </header>

        <!-- Controls -->
        <div class="bg-white shadow-md rounded-lg p-4 mb-6 flex flex-col gap-4">
            <div class="flex flex-col md:flex-row items-center justify-between gap-4">
                <div class="flex items-center space-x-2">
                    <button id="prevBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-3 rounded-lg transition-colors">&lt; Prev</button>
                    <button id="todayBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-3 rounded-lg transition-colors">Today</button>
                    <button id="nextBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-3 rounded-lg transition-colors">Next &gt;</button>
                     <h2 id="dateDisplay" class="text-lg md:text-xl font-semibold text-center w-48 md:w-64 ml-4"></h2>
                </div>
                <div class="flex items-center gap-4">
                    <div class="flex items-center justify-center border rounded-lg p-1 bg-gray-100">
                        <button id="monthViewBtn" class="view-btn px-4 py-1 text-sm font-semibold rounded-md">Month</button>
                        <button id="weekViewBtn" class="view-btn px-4 py-1 text-sm font-semibold rounded-md">Week</button>
                    </div>
                    <button id="addSampleBtn" class="w-full md:w-auto bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                        + Add
                    </button>
                </div>
            </div>
             <!-- Data Management Controls -->
            <div class="border-t pt-4 flex flex-col md:flex-row items-center justify-center gap-3">
                 <button id="labelsBtn" class="w-full md:w-auto bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">Manage Labels</button>
                 <button id="clearDataBtn" class="w-full md:w-auto bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">Clear All Data</button>
            </div>
             <!-- Color Filter -->
            <div id="colorFilterContainer" class="border-t pt-4">
                <div class="flex items-center justify-center mb-2">
                    <span class="font-medium text-sm text-gray-700 mr-4">Filter by Color:</span>
                    <button id="showAllBtn" class="text-sm font-semibold py-1 px-3 rounded-md border-2 transition-colors">Show All</button>
                </div>
                <div id="colorFilters" class="flex flex-wrap items-center justify-center gap-x-4 gap-y-2">
                    <!-- Filter swatches will be generated here -->
                </div>
            </div>
        </div>

        <!-- Day of Week Headers -->
        <div id="dayHeaders" class="grid grid-cols-7 gap-2 mb-2 text-center text-sm font-semibold text-gray-600">
            <div>Mon</div>
            <div>Tue</div>
            <div>Wed</div>
            <div>Thu</div>
            <div>Fri</div>
            <div>Sat</div>
            <div>Sun</div>
        </div>

        <!-- Calendar Grid -->
        <div id="calendarGrid" class="grid grid-cols-7 gap-2">
            <!-- Day cells will be generated by JavaScript -->
        </div>
    </div>

    <!-- Add/Edit Sample Modal -->
    <div id="sampleModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-md p-6 transform -translate-y-10">
            <h2 id="modalTitle" class="text-2xl font-bold mb-4">Add Sample Event</h2>
            <form id="sampleForm">
                <input type="hidden" id="sampleId">
                <div class="space-y-4">
                    <div>
                        <label for="stepName" class="block text-sm font-medium text-gray-700">Step Name</label>
                        <input type="text" id="stepName" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="e.g., CCC 4C" required>
                    </div>
                     <div>
                        <label class="block text-sm font-medium text-gray-700">Event Color</label>
                        <div id="colorSelector" class="mt-2 grid grid-cols-6 gap-3">
                            <!-- Color swatches will be generated here -->
                        </div>
                        <input type="hidden" id="sampleColor" value="blue">
                    </div>
                     <div>
                        <label for="testsRequested" class="block text-sm font-medium text-gray-700">Tests Requested</label>
                        <textarea id="testsRequested" rows="2" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="e.g., pH, Titer, Purity"></textarea>
                    </div>
                    <!-- Event Linking Section -->
                    <div class="p-3 bg-gray-50 rounded-lg border">
                         <label for="parentEvent" class="block text-sm font-medium text-gray-700">Link to Parent Event</label>
                         <select id="parentEvent" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                            <option value="">None (Independent Event)</option>
                         </select>
                         <div id="offsetContainer" class="mt-3 hidden space-y-2">
                             <label class="block text-sm font-medium text-gray-700">Offset from Parent</label>
                             <div class="grid grid-cols-3 gap-2">
                                <input type="number" id="offsetDays" class="w-full border-gray-300 rounded-md shadow-sm" placeholder="Days">
                                <input type="number" id="offsetHours" class="w-full border-gray-300 rounded-md shadow-sm" placeholder="Hours">
                                <input type="number" id="offsetMinutes" class="w-full border-gray-300 rounded-md shadow-sm" placeholder="Minutes">
                             </div>
                         </div>
                    </div>
                    <div>
                        <label for="sampleDateTime" class="block text-sm font-medium text-gray-700">Sample Date & Time</label>
                        <input type="datetime-local" id="sampleDateTime" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" required>
                    </div>
                </div>
                <div class="flex items-center justify-between mt-6 pt-4 border-t">
                     <div>
                        <button type="button" id="deleteBtn" class="text-red-600 hover:text-red-800 font-bold py-2 px-4 rounded-lg transition-colors hidden">Delete</button>
                        <button type="button" id="duplicateBtn" class="text-blue-600 hover:text-blue-800 font-bold py-2 px-4 rounded-lg transition-colors hidden">Duplicate</button>
                    </div>
                    <div class="flex items-center justify-end space-x-3">
                        <button type="button" id="cancelBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg transition-colors">Cancel</button>
                        <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">Save Event</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Manage Labels Modal -->
    <div id="labelsModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-2xl p-6 transform -translate-y-10">
            <h2 class="text-2xl font-bold mb-4">Manage Color Labels</h2>
            <p class="text-sm text-gray-600 mb-6">Assign a name to each color category. These labels will appear in the filter bar.</p>
            <form id="labelsForm">
                <div id="labelsList" class="grid grid-cols-1 md:grid-cols-2 gap-4 max-h-96 overflow-y-auto">
                    <!-- Label inputs will be generated here -->
                </div>
                <div class="flex items-center justify-end space-x-3 mt-6 pt-4 border-t">
                    <button type="button" id="cancelLabelsBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg transition-colors">Cancel</button>
                    <button type="submit" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">Save Labels</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, addDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, writeBatch, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        
        // Global variables for Firebase services
        let db, auth;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-calendar-app';

    document.addEventListener('DOMContentLoaded', () => {
        let currentDate = new Date();
        let samples = [];
        let colorLabels = {};
        let activeColorFilters = [];
        let currentView = 'month';

        const colorPalette = {
            blue:   { bg: 'bg-blue-100',   border: 'border-blue-500',   text: 'text-blue-800',   dot: 'bg-blue-500'   },
            green:  { bg: 'bg-green-100',  border: 'border-green-500',  text: 'text-green-800',  dot: 'bg-green-500'  },
            red:    { bg: 'bg-red-100',    border: 'border-red-500',    text: 'text-red-800',    dot: 'bg-red-500'    },
            yellow: { bg: 'bg-yellow-100', border: 'border-yellow-500', text: 'text-yellow-800', dot: 'bg-yellow-500' },
            purple: { bg: 'bg-purple-100', border: 'border-purple-500', text: 'text-purple-800', dot: 'bg-purple-500' },
            orange: { bg: 'bg-orange-100', border: 'border-orange-500', text: 'text-orange-800', dot: 'bg-orange-500' },
            teal:   { bg: 'bg-teal-100',   border: 'border-teal-500',   text: 'text-teal-800',   dot: 'bg-teal-500'   },
            pink:   { bg: 'bg-pink-100',   border: 'border-pink-500',   text: 'text-pink-800',   dot: 'bg-pink-500'   },
            indigo: { bg: 'bg-indigo-100', border: 'border-indigo-500', text: 'text-indigo-800', dot: 'bg-indigo-500' },
            gray:   { bg: 'bg-gray-100',   border: 'border-gray-500',   text: 'text-gray-800',   dot: 'bg-gray-500'   },
            cyan:   { bg: 'bg-cyan-100',   border: 'border-cyan-500',   text: 'text-cyan-800',   dot: 'bg-cyan-500'   },
            lime:   { bg: 'bg-lime-100',   border: 'border-lime-500',   text: 'text-lime-800',   dot: 'bg-lime-500'   }
        };

        const mainHeader = document.getElementById('mainHeader');
        const calendarGrid = document.getElementById('calendarGrid');
        const dateDisplayEl = document.getElementById('dateDisplay');
        const dayHeaders = document.getElementById('dayHeaders');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const todayBtn = document.getElementById('todayBtn');
        const monthViewBtn = document.getElementById('monthViewBtn');
        const weekViewBtn = document.getElementById('weekViewBtn');
        const addSampleBtn = document.getElementById('addSampleBtn');
        const labelsBtn = document.getElementById('labelsBtn');
        const clearDataBtn = document.getElementById('clearDataBtn');
        const showAllBtn = document.getElementById('showAllBtn');
        
        const modal = document.getElementById('sampleModal');
        const modalTitle = document.getElementById('modalTitle');
        const cancelBtn = document.getElementById('cancelBtn');
        const deleteBtn = document.getElementById('deleteBtn');
        const duplicateBtn = document.getElementById('duplicateBtn');
        const sampleForm = document.getElementById('sampleForm');
        const sampleIdInput = document.getElementById('sampleId');
        const stepNameInput = document.getElementById('stepName');
        const testsRequestedInput = document.getElementById('testsRequested');
        const sampleDateTimeInput = document.getElementById('sampleDateTime');
        const colorSelector = document.getElementById('colorSelector');
        const sampleColorInput = document.getElementById('sampleColor');
        const colorFiltersEl = document.getElementById('colorFilters');
        
        const labelsModal = document.getElementById('labelsModal');
        const labelsForm = document.getElementById('labelsForm');
        const labelsList = document.getElementById('labelsList');
        const cancelLabelsBtn = document.getElementById('cancelLabelsBtn');
        
        const parentEventSelect = document.getElementById('parentEvent');
        const offsetContainer = document.getElementById('offsetContainer');
        const offsetDaysInput = document.getElementById('offsetDays');
        const offsetHoursInput = document.getElementById('offsetHours');
        const offsetMinutesInput = document.getElementById('offsetMinutes');
        
        // --- DATA OPERATIONS ---
        async function clearAllData() {
            if (confirm('Are you sure you want to delete ALL schedule data and labels? This cannot be undone.')) {
                if (db) {
                    const eventsCollectionRef = collection(db, `artifacts/${appId}/public/data/events`);
                    const querySnapshot = await getDocs(eventsCollectionRef);
                    const batch = writeBatch(db);
                    querySnapshot.forEach(doc => { batch.delete(doc.ref); });
                    await batch.commit();

                    const labelsDocRef = doc(db, `artifacts/${appId}/public/data/settings`, "labels");
                    let defaultLabels = {};
                    let i = 1;
                    Object.keys(colorPalette).forEach(color => { defaultLabels[color] = `Category ${i++}`; });
                    await setDoc(labelsDocRef, defaultLabels);
                }
            }
        }
        
        async function saveLabels() {
            if(db) {
                const labelsDocRef = doc(db, `artifacts/${appId}/public/data/settings`, "labels");
                await setDoc(labelsDocRef, colorLabels, { merge: true });
            }
        }
        
        async function saveSample(sampleData) {
            if (!db) {
                alert("Database connection not available. Cannot save.");
                return;
            };
            // Central function to handle saving and updating, including children
            const isUpdating = !!sampleData.id;
            const originalSample = isUpdating ? samples.find(s => s.id === sampleData.id) : null;
            
            // 1. Save the primary event (parent)
            if (isUpdating) {
                const docRef = doc(db, `artifacts/${appId}/public/data/events`, sampleData.id);
                const dataToSave = { ...sampleData };
                delete dataToSave.id;
                await setDoc(docRef, dataToSave, { merge: true });
            } else {
                await addDoc(collection(db, `artifacts/${appId}/public/data/events`), sampleData);
            }

            // 2. If it was an update and the time changed, shift all children
            if (isUpdating && originalSample && originalSample.dateTime !== sampleData.dateTime) {
                const timeShift = new Date(sampleData.dateTime).getTime() - new Date(originalSample.dateTime).getTime();
                const children = samples.filter(s => s.parent_id === sampleData.id);
                
                if (children.length > 0) {
                    const batch = writeBatch(db);
                    children.forEach(child => {
                        const newChildTime = new Date(child.dateTime).getTime() + timeShift;
                        const childRef = doc(db, `artifacts/${appId}/public/data/events`, child.id);
                        batch.update(childRef, { dateTime: new Date(newChildTime).toISOString() });
                    });
                    await batch.commit();
                }
            }
        }
        
        async function deleteSample(id) {
            if (!db) {
                alert("Database connection not available. Cannot delete.");
                return;
            };
            // Unlink children first
            const children = samples.filter(s => s.parent_id === id);
            if (children.length > 0) {
                const batch = writeBatch(db);
                children.forEach(child => {
                    const childRef = doc(db, `artifacts/${appId}/public/data/events`, child.id);
                    batch.update(childRef, { parent_id: null, offset_ms: null });
                });
                await batch.commit();
            }

            // Delete the parent
            await deleteDoc(doc(db, `artifacts/${appId}/public/data/events`, id));
        }

        // --- TIMEZONE HELPERS ---
        function toUTC(localDateTimeStr) {
            if (!localDateTimeStr) return null;
            return new Date(localDateTimeStr).toISOString();
        }

        function fromUTC(utcDateTimeStr) {
            if (!utcDateTimeStr) return '';
            const date = new Date(utcDateTimeStr);
            return new Date(date.getTime() - (date.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
        }

        // --- MODAL & FORM HANDLING ---
        function populateParentEventSelect(currentSampleId) {
            parentEventSelect.innerHTML = '<option value="">None (Independent Event)</option>';
            samples
                .filter(s => s.id !== currentSampleId) // Can't be its own parent
                .sort((a,b) => new Date(a.dateTime) - new Date(b.dateTime))
                .forEach(s => {
                    const option = document.createElement('option');
                    option.value = s.id;
                    option.textContent = s.name;
                    parentEventSelect.appendChild(option);
                });
        }

        function calculateDateTimeFromParent() {
            const parentId = parentEventSelect.value;
            if (!parentId) return;

            const parent = samples.find(s => s.id === parentId);
            if (!parent) return;

            const days = parseInt(offsetDaysInput.value) || 0;
            const hours = parseInt(offsetHoursInput.value) || 0;
            const minutes = parseInt(offsetMinutesInput.value) || 0;

            const offsetMs = (days * 24 * 60 * 60 * 1000) + (hours * 60 * 60 * 1000) + (minutes * 60 * 1000);
            
            const parentTime = new Date(parent.dateTime).getTime();
            const newTime = new Date(parentTime + offsetMs);

            sampleDateTimeInput.value = fromUTC(newTime.toISOString());
        }
        
        function updateOffsetFields(parent, child) {
            const offsetMs = new Date(child.dateTime).getTime() - new Date(parent.dateTime).getTime();
            const minutes = Math.floor((offsetMs / (1000 * 60)) % 60);
            const hours = Math.floor((offsetMs / (1000 * 60 * 60)) % 24);
            const days = Math.floor(offsetMs / (1000 * 60 * 60 * 24));
            offsetDaysInput.value = days || '';
            offsetHoursInput.value = hours || '';
            offsetMinutesInput.value = minutes || '';
        }

        function populateColorSelector() {
            colorSelector.innerHTML = '';
            Object.keys(colorPalette).forEach(color => {
                const swatch = document.createElement('div');
                swatch.className = `color-swatch w-8 h-8 rounded-full cursor-pointer ${colorPalette[color].dot}`;
                swatch.dataset.color = color;
                colorSelector.appendChild(swatch);
            });
        }

        colorSelector.addEventListener('click', (e) => {
            if (e.target.dataset.color) {
                const selectedColor = e.target.dataset.color;
                sampleColorInput.value = selectedColor;
                colorSelector.querySelectorAll('.color-swatch').forEach(sw => {
                    sw.classList.toggle('selected', sw.dataset.color === selectedColor);
                });
            }
        });

        function showModal(id) {
            sampleForm.reset();
            populateParentEventSelect(id);
            let activeColor = 'blue';
            let sample = samples.find(s => s.id === id);

            if (sample) { // Editing
                modalTitle.textContent = 'Edit Sample Event';
                sampleIdInput.value = sample.id;
                stepNameInput.value = sample.name;
                testsRequestedInput.value = sample.tests || '';
                sampleDateTimeInput.value = fromUTC(sample.dateTime);
                activeColor = sample.color || 'blue';
                deleteBtn.classList.remove('hidden');
                duplicateBtn.classList.remove('hidden');

                if (sample.parent_id) {
                    parentEventSelect.value = sample.parent_id;
                    const parent = samples.find(s => s.id === sample.parent_id);
                    if (parent) {
                        updateOffsetFields(parent, sample);
                    }
                    offsetContainer.classList.remove('hidden');
                    sampleDateTimeInput.readOnly = true;
                } else {
                     offsetContainer.classList.add('hidden');
                     sampleDateTimeInput.readOnly = false;
                }

            } else { // Adding new event
                modalTitle.textContent = 'Add Sample Event';
                sampleIdInput.value = '';
                sampleDateTimeInput.value = fromUTC(new Date().toISOString());
                deleteBtn.classList.add('hidden');
                duplicateBtn.classList.add('hidden');
                offsetContainer.classList.add('hidden');
                sampleDateTimeInput.readOnly = false;
            }

            sampleColorInput.value = activeColor;
            colorSelector.querySelectorAll('.color-swatch').forEach(sw => {
                sw.classList.toggle('selected', sw.dataset.color === activeColor);
            });
            
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                modal.querySelector('.modal-content').classList.remove('-translate-y-10');
            }, 10);
        }
        
        function hideModal(modalElement) {
            modalElement.classList.add('opacity-0');
            modalElement.querySelector('.modal-content').classList.add('-translate-y-10');
            setTimeout(() => modalElement.classList.add('hidden'), 250);
        }

        sampleForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                const id = sampleIdInput.value;
                const parentId = parentEventSelect.value;
                const days = parseInt(offsetDaysInput.value) || 0;
                const hours = parseInt(offsetHoursInput.value) || 0;
                const minutes = parseInt(offsetMinutesInput.value) || 0;
                const offsetMs = (days * 24 * 60 * 60 * 1000) + (hours * 60 * 60 * 1000) + (minutes * 60 * 1000);

                const newSample = {
                    name: stepNameInput.value,
                    tests: testsRequestedInput.value,
                    dateTime: toUTC(sampleDateTimeInput.value),
                    color: sampleColorInput.value,
                    parent_id: parentId || null,
                    offset_ms: parentId ? offsetMs : null,
                };
                if(id) newSample.id = id;

                await saveSample(newSample);
                hideModal(modal);
            } catch (error) {
                console.error("Error saving event:", error);
                alert("Could not save the event. Please check the console for details.");
            }
        });
        
        duplicateBtn.addEventListener('click', async () => {
             try {
                const parentId = parentEventSelect.value;
                const days = parseInt(offsetDaysInput.value) || 0;
                const hours = parseInt(offsetHoursInput.value) || 0;
                const minutes = parseInt(offsetMinutesInput.value) || 0;
                const offsetMs = (days * 24 * 60 * 60 * 1000) + (hours * 60 * 60 * 1000) + (minutes * 60 * 1000);
                
                const newSample = {
                    name: stepNameInput.value,
                    tests: testsRequestedInput.value,
                    dateTime: toUTC(sampleDateTimeInput.value),
                    color: sampleColorInput.value,
                    parent_id: parentId || null,
                    offset_ms: parentId ? offsetMs : null,
                };
                await saveSample(newSample);
                hideModal(modal);
            } catch (error) {
                console.error("Error duplicating event:", error);
                alert("Could not duplicate the event. Please check the console for details.");
            }
        });

        deleteBtn.addEventListener('click', async () => {
            const idToDelete = sampleIdInput.value;
            if (idToDelete) {
                try {
                    await deleteSample(idToDelete);
                    // The confirmation is now inside deleteSample
                } catch (error) {
                    console.error("Error deleting event:", error);
                    alert("Could not delete the event. Please check the console for details.");
                }
            }
        });


        function showLabelsModal() {
            labelsList.innerHTML = '';
            Object.keys(colorPalette).forEach(color => {
                const labelItem = document.createElement('div');
                labelItem.className = 'flex items-center gap-3';
                labelItem.innerHTML = `<div class="w-6 h-6 rounded-full ${colorPalette[color].dot}"></div><input type="text" data-color="${color}" value="${colorLabels[color] || ''}" class="flex-grow block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm">`;
                labelsList.appendChild(labelItem);
            });
            labelsModal.classList.remove('hidden');
            setTimeout(() => {
                labelsModal.classList.remove('opacity-0');
                labelsModal.querySelector('.modal-content').classList.remove('-translate-y-10');
            }, 10);
        }

        labelsForm.addEventListener('submit', (e) => {
            e.preventDefault();
            labelsList.querySelectorAll('input[type="text"]').forEach(input => {
                colorLabels[input.dataset.color] = input.value;
            });
            saveLabels();
            hideModal(labelsModal);
        });

        // --- CALENDAR RENDERING ---
        function renderColorFilters() {
            colorFiltersEl.innerHTML = '';
            Object.keys(colorPalette).forEach(color => {
                const filterItem = document.createElement('div');
                filterItem.className = 'filter-swatch flex items-center gap-2 cursor-pointer p-1 rounded-md border-2 border-transparent';
                if (activeColorFilters.includes(color)) { filterItem.classList.add('selected'); }
                filterItem.dataset.color = color;
                filterItem.innerHTML = `<div class="w-5 h-5 rounded-full ${colorPalette[color].dot}"></div><span class="text-xs font-medium text-gray-700">${colorLabels[color] || color}</span>`;
                filterItem.addEventListener('click', () => {
                    const index = activeColorFilters.indexOf(color);
                    if (index > -1) { activeColorFilters.splice(index, 1); } 
                    else { activeColorFilters.push(color); }
                    renderAll();
                });
                colorFiltersEl.appendChild(filterItem);
            });
            
            showAllBtn.classList.toggle('bg-blue-500', activeColorFilters.length === 0);
            showAllBtn.classList.toggle('text-white', activeColorFilters.length === 0);
            showAllBtn.classList.toggle('border-blue-500', activeColorFilters.length === 0);
            showAllBtn.classList.toggle('bg-gray-200', activeColorFilters.length > 0);
            showAllBtn.classList.toggle('hover:bg-gray-300', activeColorFilters.length > 0);
            showAllBtn.classList.toggle('border-gray-200', activeColorFilters.length > 0);
        }
        
        function getStartOfWeek(date) {
            const d = new Date(date);
            let day = d.getDay();
            day = day === 0 ? 6 : day - 1; // Monday is 0
            const diff = d.getDate() - day;
            return new Date(d.setDate(diff));
        }

        function updateHeaderAndGrid() {
            if (currentView === 'month') {
                mainHeader.textContent = 'Monthly Sample Schedule';
                dateDisplayEl.textContent = currentDate.toLocaleString('en-US', { month: 'long', year: 'numeric' });
                calendarGrid.classList.remove('md:grid-rows-1');
                dayHeaders.classList.remove('hidden');
            } else { // week view
                mainHeader.textContent = 'Weekly Sample Schedule';
                const startOfWeek = getStartOfWeek(new Date(currentDate));
                const endOfWeek = new Date(startOfWeek);
                endOfWeek.setDate(endOfWeek.getDate() + 6);
                const options = { month: 'short', day: 'numeric' };
                dateDisplayEl.textContent = `${startOfWeek.toLocaleDateString('en-US', options)} - ${endOfWeek.toLocaleDateString('en-US', { ...options, year: 'numeric' })}`;
                calendarGrid.classList.add('md:grid-rows-1');
                dayHeaders.classList.add('hidden');
            }
        }

        function renderCalendar() {
            calendarGrid.innerHTML = '';
            updateHeaderAndGrid();

            if (currentView === 'month') {
                renderMonthView();
            } else {
                renderWeekView();
            }
        }
        
        function renderMonthView() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const firstDayOfMonth = new Date(year, month, 1);
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            let startingDay = firstDayOfMonth.getDay();
            startingDay = startingDay === 0 ? 6 : startingDay - 1;
            const daysInPrevMonth = new Date(year, month, 0).getDate();

            for (let i = 0; i < startingDay; i++) {
                createDayCell(new Date(year, month - 1, daysInPrevMonth - startingDay + 1 + i), false);
            }
            for (let i = 1; i <= daysInMonth; i++) {
                createDayCell(new Date(year, month, i), true);
            }
            const totalCells = calendarGrid.children.length;
            const remainingCells = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
            for (let i = 1; i <= remainingCells; i++) {
                createDayCell(new Date(year, month + 1, i), false);
            }
        }

        function renderWeekView() {
            const startOfWeek = getStartOfWeek(new Date(currentDate));
            for (let i = 0; i < 7; i++) {
                const day = new Date(startOfWeek);
                day.setDate(day.getDate() + i);
                createDayCell(day, true, true);
            }
        }

        function createDayCell(day, isCurrentMonth, isWeekView = false) {
            const samplesForDay = getSamplesForDay(day);
            const dayCell = document.createElement('div');
            
            let classes = 'bg-white rounded-lg shadow p-3 flex flex-col';
            if (isWeekView) { classes += ' min-h-[80vh]'; } 
            else { classes += ' min-h-[200px] md:min-h-[250px]'; }

            dayCell.className = isCurrentMonth ? classes : classes.replace('bg-white', 'bg-gray-50 text-gray-400');
            
            const today = new Date();
            const isToday = day.toDateString() === today.toDateString();
            
            let dayHeaderHTML = isWeekView ? `<div class="text-center text-sm font-semibold text-gray-600 mb-2">${day.toLocaleDateString('en-US', { weekday: 'long' })}</div>` : '';

            let dayNumberClasses = 'text-sm rounded-full h-8 w-8 flex items-center justify-center font-semibold';
            if (isCurrentMonth) {
                dayNumberClasses += isToday ? ' bg-blue-500 text-white' : ' bg-gray-200 text-gray-800';
            } else {
                dayNumberClasses += ' bg-gray-100 text-gray-400';
            }

            dayCell.innerHTML = `
                ${dayHeaderHTML}
                <div class="flex justify-between items-center mb-2">
                    <div class="flex items-center space-x-2">
                         ${samplesForDay.length > 0 ? `<span class="text-xs font-bold bg-blue-100 text-blue-800 px-2 py-1 rounded-full">${samplesForDay.length}</span>` : ''}
                    </div>
                    <span class="${dayNumberClasses}">${day.getDate()}</span>
                </div>
                <div class="relative h-6 bg-gray-100 rounded-full mb-3 border">
                    <div class="absolute w-full h-full flex justify-between px-2"><div class="h-full border-l border-gray-300"></div><div class="h-full border-l border-gray-300"></div><div class="h-full border-l border-gray-300"></div></div>
                </div>
                <div class="flex-grow space-y-2 overflow-y-auto text-gray-800"></div>`;

            const timelineEl = dayCell.querySelector('.relative.h-6');
            samplesForDay.forEach(sample => {
                const sampleDate = new Date(sample.dateTime);
                const minutesInDay = sampleDate.getUTCHours() * 60 + sampleDate.getUTCMinutes();
                const percentage = (minutesInDay / (24 * 60)) * 100;
                const marker = document.createElement('div');
                marker.className = 'timeline-marker absolute top-0 h-full flex items-center';
                marker.style.left = `${percentage}%`;
                const sampleTime = sampleDate.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true, timeZone: 'UTC' });
                const colorClasses = colorPalette[sample.color] || colorPalette.blue;
                let tooltipTestsHTML = sample.tests ? `<br><span class="font-normal text-gray-300">Tests: ${sample.tests}</span>` : '';
                marker.innerHTML = `<div class="w-3 h-3 ${colorClasses.dot} rounded-full border-2 border-white transform -translate-x-1/2"></div><div class="tooltip absolute bottom-full mb-2 w-max p-2 text-xs bg-gray-800 text-white rounded-md transform -translate-x-1/2 left-1/2"><strong>${sample.name}</strong> (${sampleTime} UTC)${tooltipTestsHTML}</div>`;
                timelineEl.appendChild(marker);
            });
            
            const sampleListEl = dayCell.querySelector('.flex-grow');
            if (samplesForDay.length === 0) {
                 sampleListEl.innerHTML = `<p class="text-xs text-center mt-4 ${isCurrentMonth ? 'text-gray-400' : 'text-gray-300'}">No samples</p>`;
            } else {
                samplesForDay.forEach(sample => {
                    const colorClasses = colorPalette[sample.color] || colorPalette.blue;
                    const sampleCard = document.createElement('div');
                    sampleCard.className = `${colorClasses.bg} border-l-4 ${colorClasses.border} rounded p-2 text-sm cursor-pointer hover:opacity-80 transition-opacity group relative`;
                    
                    const sampleTime = new Date(sample.dateTime).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
                    let testsHTML = sample.tests ? `<p class="text-xs text-gray-500 mt-1 truncate" title="${sample.tests}">${sample.tests}</p>` : '';
                    let linkIcon = sample.parent_id ? `<svg class="w-3 h-3 text-gray-500 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path></svg>`: '';

                    sampleCard.innerHTML = `<div><div class="flex items-center"><p class="font-semibold ${colorClasses.text}">${sample.name}</p>${linkIcon}</div><p class="text-xs text-gray-600">${sampleTime}</p>${testsHTML}</div>`;
                    
                    sampleCard.addEventListener('click', (e) => { showModal(sample.id); });
                    sampleListEl.appendChild(sampleCard);
                });
            }
            calendarGrid.appendChild(dayCell);
        }

        function getSamplesForDay(day) {
            const dayStart = new Date(day);
            dayStart.setUTCHours(0,0,0,0);
            const dayEnd = new Date(dayStart);
            dayEnd.setUTCDate(dayEnd.getUTCDate() + 1);

            let samplesForDay = samples.filter(s => {
                if (!s.dateTime) return false;
                const sampleDate = new Date(s.dateTime);
                return sampleDate >= dayStart && sampleDate < dayEnd;
            }).sort((a, b) => new Date(a.dateTime) - new Date(b.dateTime));

            if (activeColorFilters.length > 0) {
                samplesForDay = samplesForDay.filter(s => activeColorFilters.includes(s.color));
            }
            return samplesForDay;
        }

        function renderAll() {
            renderColorFilters();
            renderCalendar();
            updateViewSwitcher();
        }

        function updateViewSwitcher() {
            monthViewBtn.classList.toggle('active', currentView === 'month');
            weekViewBtn.classList.toggle('active', currentView === 'week');
        }
        
        function initializeCalendar() {
             // --- EVENT LISTENERS ---
            prevBtn.addEventListener('click', () => { 
                if (currentView === 'month') { currentDate.setMonth(currentDate.getMonth() - 1); } 
                else { currentDate.setDate(currentDate.getDate() - 7); }
                renderCalendar(); 
            });
            nextBtn.addEventListener('click', () => { 
                if (currentView === 'month') { currentDate.setMonth(currentDate.getMonth() + 1); } 
                else { currentDate.setDate(currentDate.getDate() + 7); }
                renderCalendar(); 
            });
            todayBtn.addEventListener('click', () => { currentDate = new Date(); renderCalendar(); });
            monthViewBtn.addEventListener('click', () => { if(currentView !== 'month') { currentView = 'month'; renderAll(); } });
            weekViewBtn.addEventListener('click', () => { if(currentView !== 'week') { currentView = 'week'; renderAll(); } });

            addSampleBtn.addEventListener('click', () => showModal());
            cancelBtn.addEventListener('click', () => hideModal(modal));
            modal.addEventListener('click', (e) => { if (e.target === modal) hideModal(modal); });
            
            labelsBtn.addEventListener('click', showLabelsModal);
            cancelLabelsBtn.addEventListener('click', () => hideModal(labelsModal));
            labelsModal.addEventListener('click', (e) => { if (e.target === labelsModal) hideModal(labelsModal); });

            showAllBtn.addEventListener('click', () => { activeColorFilters = []; renderAll(); });
            clearDataBtn.addEventListener('click', clearAllData);

            [parentEventSelect, offsetDaysInput, offsetHoursInput, offsetMinutesInput].forEach(el => {
                el.addEventListener('change', () => {
                    const parentId = parentEventSelect.value;
                    if (parentId) {
                        offsetContainer.classList.remove('hidden');
                        sampleDateTimeInput.readOnly = true;
                        calculateDateTimeFromParent();
                    } else {
                        offsetContainer.classList.add('hidden');
                        sampleDateTimeInput.readOnly = false;
                    }
                });
            });
            
            populateColorSelector();
            renderAll();
        }

        // --- MAIN INITIALIZATION FUNCTION ---
        async function main() {
            try {
                const app = initializeApp(JSON.parse(__firebase_config));
                db = getFirestore(app);
                auth = getAuth(app);
                
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
                
                onAuthStateChanged(auth, user => {
                    if (user) {
                        console.log("Firebase Authenticated. User:", user.uid);
                        // Setup listeners only after a user is confirmed
                        const eventsCollectionRef = collection(db, `artifacts/${appId}/public/data/events`);
                        onSnapshot(eventsCollectionRef, (snapshot) => {
                            samples = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            renderAll();
                        }, (error) => {
                            console.error("Error with events listener:", error);
                        });

                        const labelsDocRef = doc(db, `artifacts/${appId}/public/data/settings`, "labels");
                        onSnapshot(labelsDocRef, (doc) => {
                            if (doc.exists()) {
                                colorLabels = doc.data();
                            } else {
                                let i = 1;
                                Object.keys(colorPalette).forEach(color => { colorLabels[color] = `Category ${i++}`; });
                                saveLabels(); // Auto-create labels if they don't exist
                            }
                            renderAll();
                        }, (error) => {
                            console.error("Error with labels listener:", error);
                        });
                    }
                });
            } catch (e) {
                console.error("Firebase initialization failed.", e);
                db = null;
            }
            initializeCalendar();
        }

        // --- START THE APP ---
        main();
    });
    </script>
</body>
</html>

